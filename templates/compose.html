{% extends "base.html" %}
{% block title %}Compose{% endblock %}

{% block content %}
<!-- COMPOSE HERO -->
<div style="position: relative; margin: -16px -16px 16px -16px; height: 80px; overflow: hidden;">
    <img src="/static/photos/xmas-whiskey-sour-2.jpg" alt="" style="position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0.25; filter: blur(1px);">
    <div style="position: relative; z-index: 1; height: 100%; display: flex; align-items: center; padding: 0 16px;">
        <div>
            <h1 style="font-family: 'Cormorant Garamond', serif; font-size: 1.3rem; color: var(--gold); margin: 0;">{% if post %}Edit Post{% else %}Compose{% endif %}</h1>
            <p style="font-size: 1.05rem; color: var(--text-muted); margin: 2px 0 0 0;">{% if post %}Update your post{% else %}Create content for your audience{% endif %}</p>
        </div>
    </div>
</div>

<!-- AI CONTENT GENERATOR -->
<div class="ai-panel" id="aiPanel">
    <div class="ai-header">
        <span class="ai-icon">âœ¦</span>
        <span class="ai-title">AI Content Generator</span>
    </div>
    
    <div class="form-group">
        <label class="form-label">What should we write about?</label>
        <input type="text" class="form-input" id="aiTopic" placeholder="e.g., Weekend bourbon cocktail, Tasting notes, Holiday gift guide...">
    </div>
    
    <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px;">
        <div style="flex: 1; min-width: 120px;">
            <label class="form-label">Type</label>
            <select class="form-select" id="aiType">
                <option value="social_post">Social Post</option>
                <option value="engagement">Engagement Q</option>
                <option value="caption">Caption</option>
                <option value="thread">Thread</option>
                <option value="blog_intro">Blog Intro</option>
            </select>
        </div>
        <div style="flex: 1; min-width: 120px;">
            <label class="form-label">Tone</label>
            <select class="form-select" id="aiTone">
                <option value="professional">Professional</option>
                <option value="casual">Casual</option>
                <option value="playful">Playful</option>
                <option value="educational">Educational</option>
                <option value="luxury">Luxury</option>
            </select>
        </div>
        <div style="flex: 1; min-width: 120px;">
            <label class="form-label">Platform</label>
            <select class="form-select" id="aiPlatform">
                <option value="general">General</option>
                <option value="twitter">Twitter / X</option>
                <option value="bluesky">Bluesky</option>
                <option value="facebook">Facebook</option>
                <option value="linkedin">LinkedIn</option>
                <option value="instagram">Instagram</option>
            </select>
        </div>
    </div>
    
    <div class="form-group">
        <label class="form-label">Or write a custom prompt</label>
        <input type="text" class="form-input" id="aiCustomPrompt" placeholder="Custom instructions for Claude...">
    </div>
    
    <button class="btn btn-primary btn-block" onclick="generateContent()" id="aiGenerateBtn">
        âœ¦ Generate Content
    </button>
    
    <div class="ai-loading" id="aiLoading">
        <div class="spinner"></div>
        <span>Claude is crafting your content...</span>
    </div>
</div>

<!-- COMPOSE FORM -->
<form id="composeForm" method="POST" action="/api/posts" enctype="multipart/form-data">
    <!-- Content -->
    <div class="form-group">
        <label class="form-label">Post Content</label>
        <textarea class="form-textarea" id="postContent" name="content" placeholder="What's on your mind about Forbidden Bourbon?" style="min-height: 150px;" required>{% if post %}{{ post.content }}{% elif template %}{{ template.content }}{% endif %}</textarea>
        <div class="char-count" id="charCount">0 / 280</div>
    </div>
    
    <!-- Image Upload -->
    <div class="form-group">
        <label class="form-label">Image (Optional)</label>
        <div class="image-upload-area" id="imageUploadArea" onclick="document.getElementById('imageInput').click()">
            {% if post and post.image_path %}
                <img src="{{ post.image_path }}" alt="Post image" id="imagePreview">
            {% else %}
                <div id="imagePrompt">
                    <div style="font-size: 1.5rem; margin-bottom: 6px;">ðŸ“·</div>
                    <div>Tap to upload an image</div>
                    <div class="text-xs text-muted mt-sm">JPG, PNG, GIF, WebP â€” Max 16MB</div>
                </div>
                <img id="imagePreview" style="display: none;" alt="Preview">
            {% endif %}
            <input type="file" name="image" id="imageInput" accept="image/*">
        </div>
        {% if post and post.image_path %}
        <button type="button" class="btn btn-ghost btn-sm mt-sm" onclick="clearImage()">Remove image</button>
        {% endif %}
    </div>
    
    <!-- Hashtags -->
    <div class="form-group">
        <label class="form-label">Hashtags</label>
        <input type="text" class="form-input" id="hashtagInput" name="hashtags" 
               placeholder="#forbiddenbourbon #bourbon #whiskey"
               value="{% if post %}{{ post.hashtags }}{% elif template %}{{ template.hashtags }}{% endif %}">
        
        <div style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 6px;">
            {% for group in hashtag_groups %}
            <button type="button" class="hashtag-group-btn" onclick="addHashtags('{{ group.hashtags }}')">
                {{ group.name }}
            </button>
            {% endfor %}
        </div>
    </div>
    
    <!-- Link URL -->
    <div class="form-group">
        <label class="form-label">Link (Optional)</label>
        <input type="url" class="form-input" name="link_url" placeholder="https://drinkforbidden.com/..."
               value="{% if post %}{{ post.link_url }}{% endif %}">
    </div>
    
    <!-- Platform Selection -->
    <div class="form-group">
        <label class="form-label">Publish To</label>
        <div class="checkbox-group">
            {% for p in platforms %}
            <label class="checkbox-pill {% if post and p.name in post.platforms|map(attribute='platform_name')|list %}checked{% endif %} {% if not p.connected %}text-muted{% endif %}">
                <input type="checkbox" name="platforms" value="{{ p.name }}"
                    {% if post and p.name in post.platforms|map(attribute='platform_name')|list %}checked{% endif %}
                    {% if not p.connected %}disabled{% endif %}>
                <span class="platform-dot {{ p.name }}"></span>
                {{ p.display_name }}
                {% if not p.connected %}<span class="text-xs">(not connected)</span>{% endif %}
            </label>
            {% endfor %}
        </div>
    </div>
    
    <!-- Schedule -->
    <div class="form-group">
        <label class="form-label">Schedule (Optional)</label>
        <input type="datetime-local" class="form-input" name="scheduled_at" id="scheduledAt"
               value="{% if post and post.scheduled_at %}{{ post.scheduled_at|caldate }}{% endif %}">
    </div>
    
    <!-- Notes -->
    <div class="form-group">
        <label class="form-label">Internal Notes (Optional)</label>
        <input type="text" class="form-input" name="notes" placeholder="Notes for yourself..."
               value="{% if post %}{{ post.notes }}{% endif %}">
    </div>
    
    <input type="hidden" name="ai_generated" id="aiGeneratedFlag" value="0">
    <input type="hidden" name="status" id="postStatus" value="draft">
    
    <!-- ACTION BUTTONS -->
    <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 24px;">
        <button type="submit" class="btn btn-secondary" style="flex: 1;" onclick="document.getElementById('postStatus').value='draft'">
            Save Draft
        </button>
        <button type="submit" class="btn btn-primary" style="flex: 1;" id="schedulePublishBtn" onclick="setSubmitAction()">
            {% if post and post.status == 'scheduled' %}Update Schedule{% else %}Schedule / Publish{% endif %}
        </button>
    </div>
    
    {% if post %}
    <div style="margin-top: 12px;">
        <button type="button" class="btn btn-danger btn-block btn-sm" onclick="deletePost({{ post.id }})">
            Delete Post
        </button>
    </div>
    {% endif %}
</form>

<!-- TEMPLATE PICKER -->
{% if templates and not post %}
<div class="section-divider"><span>Or use a template</span></div>

<div id="templateList">
    {% for t in templates[:6] %}
    <div class="template-card" onclick="useTemplate({{ t.id }}, `{{ t.content|replace('`', '') }}`, '{{ t.hashtags }}')">
        <div class="template-title">{{ t.title }}</div>
        <div class="template-preview">{{ t.content[:100] }}...</div>
        <div class="template-meta">
            <span class="template-category">{{ t.category }}</span>
            <span>Used {{ t.use_count }}x</span>
        </div>
    </div>
    {% endfor %}
</div>

{% if templates|length > 6 %}
<a href="/templates" class="btn btn-ghost btn-block btn-sm">View All Templates â†’</a>
{% endif %}
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    const contentEl = document.getElementById('postContent');
    const charCountEl = document.getElementById('charCount');
    const imageInput = document.getElementById('imageInput');
    const imagePreview = document.getElementById('imagePreview');
    const imagePrompt = document.getElementById('imagePrompt');
    const uploadArea = document.getElementById('imageUploadArea');
    
    // Character counter
    function updateCharCount() {
        const len = contentEl.value.length;
        charCountEl.textContent = `${len} / 280`;
        charCountEl.className = 'char-count';
        if (len > 280) charCountEl.className = 'char-count danger';
        else if (len > 250) charCountEl.className = 'char-count warning';
    }
    
    contentEl.addEventListener('input', updateCharCount);
    updateCharCount();
    
    // Image preview
    imageInput.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                imagePreview.src = e.target.result;
                imagePreview.style.display = 'block';
                if (imagePrompt) imagePrompt.style.display = 'none';
                uploadArea.classList.add('has-image');
            };
            reader.readAsDataURL(file);
        }
    });
    
    function clearImage() {
        imageInput.value = '';
        imagePreview.style.display = 'none';
        imagePreview.src = '';
        if (imagePrompt) imagePrompt.style.display = 'block';
        uploadArea.classList.remove('has-image');
    }
    
    // Hashtag insertion
    function addHashtags(tags) {
        const input = document.getElementById('hashtagInput');
        const existing = input.value.trim();
        if (existing) {
            // Avoid duplicates
            const existingTags = existing.split(/\s+/);
            const newTags = tags.split(/\s+/).filter(t => !existingTags.includes(t));
            input.value = existing + ' ' + newTags.join(' ');
        } else {
            input.value = tags;
        }
    }
    
    // Use template
    function useTemplate(id, content, hashtags) {
        contentEl.value = content;
        document.getElementById('hashtagInput').value = hashtags;
        updateCharCount();
        contentEl.focus();
        window.scrollTo({ top: 0, behavior: 'smooth' });
        showToast('Template loaded', 'success');
    }
    
    // Set submit action (schedule vs publish)
    function setSubmitAction() {
        const scheduledAt = document.getElementById('scheduledAt').value;
        if (scheduledAt) {
            document.getElementById('postStatus').value = 'scheduled';
        } else {
            document.getElementById('postStatus').value = 'draft';
            // If no schedule time, just save as draft with platforms selected
        }
    }
    
    // AI Content Generation
    async function generateContent() {
        const topic = document.getElementById('aiTopic').value.trim();
        const type = document.getElementById('aiType').value;
        const tone = document.getElementById('aiTone').value;
        const platform = document.getElementById('aiPlatform').value;
        const customPrompt = document.getElementById('aiCustomPrompt').value.trim();
        
        if (!topic && !customPrompt) {
            showToast('Enter a topic or custom prompt', 'error');
            return;
        }
        
        const btn = document.getElementById('aiGenerateBtn');
        const loading = document.getElementById('aiLoading');
        btn.disabled = true;
        btn.textContent = 'Generating...';
        loading.classList.add('active');
        
        try {
            const resp = await fetch('/api/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ topic, type, tone, platform, custom_prompt: customPrompt })
            });
            
            const data = await resp.json();
            
            if (data.success) {
                contentEl.value = data.content;
                document.getElementById('aiGeneratedFlag').value = '1';
                updateCharCount();
                showToast('Content generated!', 'success');
            } else {
                showToast(data.error || 'Generation failed', 'error');
            }
        } catch (err) {
            showToast('Network error: ' + err.message, 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = 'âœ¦ Generate Content';
            loading.classList.remove('active');
        }
    }
    
    // Form submission
    document.getElementById('composeForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        try {
            const resp = await fetch('/api/posts', {
                method: 'POST',
                body: formData
            });
            
            const data = await resp.json();
            
            if (data.success) {
                const status = data.status;
                showToast(
                    status === 'scheduled' ? 'Post scheduled!' : 'Post saved as draft!',
                    'success'
                );
                setTimeout(() => window.location.href = '/queue', 1000);
            } else {
                showToast(data.error || 'Failed to save post', 'error');
            }
        } catch (err) {
            showToast('Error: ' + err.message, 'error');
        }
    });
    
    // Delete post
    async function deletePost(postId) {
        if (!confirmAction('Are you sure you want to delete this post?')) return;
        
        try {
            const data = await apiCall(`/api/posts/${postId}`, 'DELETE');
            if (data.success) {
                showToast('Post deleted', 'success');
                setTimeout(() => window.location.href = '/queue', 1000);
            } else {
                showToast(data.error || 'Delete failed', 'error');
            }
        } catch (err) {
            showToast('Error: ' + err.message, 'error');
        }
    }
    
    // Open AI panel if URL param
    {% if request.args.get('ai') %}
    document.getElementById('aiTopic').focus();
    {% endif %}
</script>
{% endblock %}
